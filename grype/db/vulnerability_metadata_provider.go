package db

import (
	"fmt"

	grypeDB "github.com/anchore/grype/grype/db/v5"
	"github.com/anchore/grype/grype/vulnerability"
)

var _ vulnerability.MetadataProvider = (*VulnerabilityMetadataProvider)(nil)

type VulnerabilityMetadataProvider struct {
	reader grypeDB.VulnerabilityMetadataStoreReader
}

func NewVulnerabilityMetadataProvider(reader grypeDB.VulnerabilityMetadataStoreReader) *VulnerabilityMetadataProvider {
	return &VulnerabilityMetadataProvider{
		reader: reader,
	}
}

func (pr *VulnerabilityMetadataProvider) GetMetadata(id, namespace, metadataNamespace string) (*vulnerability.Metadata, error) {
	// TODO: WILL: try using metadata namespace
	if metadataNamespace != "" {
		metadata, err := pr.reader.GetVulnerabilityMetadata(id, metadataNamespace)
		if err != nil {
			return nil, fmt.Errorf("metadata provider failed to fetch id='%s' recordsource='%s': %w", id, namespace, err)
		}
		if metadata != nil {
			return vulnerability.NewMetadata(metadata)
		}
	}
	metadata, err := pr.reader.GetVulnerabilityMetadata(id, namespace)
	if err != nil {
		return nil, fmt.Errorf("metadata provider failed to fetch id='%s' recordsource='%s': %w", id, namespace, err)
	}

	return vulnerability.NewMetadata(metadata)
}
